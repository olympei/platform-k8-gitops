# Extended RBAC for External DNS
# Apply this file after deploying External DNS with Helm
# kubectl apply -f charts/external-dns/k8s-resources/extended-rbac.yaml

---
# Extended ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-dns-extended
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac-extended
  annotations:
    description: "Extended permissions for External DNS"
rules:
  # Core resources
  - apiGroups: [""]
    resources: [services, endpoints, pods, nodes]
    verbs: [get, list, watch]
  
  # Ingress
  - apiGroups: [extensions, networking.k8s.io]
    resources: [ingresses]
    verbs: [get, list, watch]
  
  # Gateway API
  - apiGroups: [gateway.networking.k8s.io]
    resources: [gateways, httproutes, tlsroutes, tcproutes, udproutes, grpcroutes]
    verbs: [get, list, watch]
  
  # Istio
  - apiGroups: [networking.istio.io]
    resources: [gateways, virtualservices]
    verbs: [get, list, watch]
  
  # DNSEndpoint CRD
  - apiGroups: [externaldns.k8s.io]
    resources: [dnsendpoints]
    verbs: [get, list, watch, update, patch]
  
  # Events
  - apiGroups: [""]
    resources: [events]
    verbs: [create, patch]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-dns-extended
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac-extended
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-dns-extended
subjects:
  - kind: ServiceAccount
    name: external-dns
    namespace: external-dns

---
# CRD Reader ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-dns-crd-reader
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac-crd-reader
rules:
  - apiGroups: [apiextensions.k8s.io]
    resources: [customresourcedefinitions]
    verbs: [get, list, watch]

---
# CRD Reader ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-dns-crd-reader
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac-crd-reader
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-dns-crd-reader
subjects:
  - kind: ServiceAccount
    name: external-dns
    namespace: external-dns

---
# Namespace Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: external-dns-namespace
  namespace: external-dns
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac-namespace
rules:
  - apiGroups: [""]
    resources: [configmaps]
    verbs: [get, list, watch]
  
  - apiGroups: [coordination.k8s.io]
    resources: [leases]
    verbs: [get, list, watch, create, update, patch]

---
# Namespace RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: external-dns-namespace
  namespace: external-dns
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac-namespace
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: external-dns-namespace
subjects:
  - kind: ServiceAccount
    name: external-dns
    namespace: external-dns
