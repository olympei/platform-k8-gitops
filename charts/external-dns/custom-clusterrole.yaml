# Custom ClusterRole for External DNS
# This provides additional permissions beyond the default Helm chart
# Deploy this alongside the External DNS Helm release

---
# Extended ClusterRole for External DNS
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-dns-extended
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: manual
  annotations:
    description: "Extended permissions for External DNS to watch additional resources"
rules:
  # Core resources (standard External DNS permissions)
  - apiGroups: [""]
    resources:
      - services
      - endpoints
      - pods
      - nodes
    verbs:
      - get
      - list
      - watch

  # Ingress resources
  - apiGroups:
      - extensions
      - networking.k8s.io
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch

  # Gateway API resources (for future use)
  - apiGroups:
      - gateway.networking.k8s.io
    resources:
      - gateways
      - httproutes
      - tlsroutes
      - tcproutes
      - udproutes
      - grpcroutes
    verbs:
      - get
      - list
      - watch

  # Istio resources
  - apiGroups:
      - networking.istio.io
    resources:
      - gateways
      - virtualservices
    verbs:
      - get
      - list
      - watch

  # Contour HTTPProxy
  - apiGroups:
      - projectcontour.io
    resources:
      - httpproxies
    verbs:
      - get
      - list
      - watch

  # Ambassador Mapping
  - apiGroups:
      - getambassador.io
    resources:
      - hosts
      - mappings
    verbs:
      - get
      - list
      - watch

  # Traefik IngressRoute
  - apiGroups:
      - traefik.containo.us
      - traefik.io
    resources:
      - ingressroutes
      - ingressroutetcps
      - ingressrouteudps
    verbs:
      - get
      - list
      - watch

  # F5 VirtualServer
  - apiGroups:
      - cis.f5.com
    resources:
      - virtualservers
    verbs:
      - get
      - list
      - watch

  # OpenShift Route
  - apiGroups:
      - route.openshift.io
    resources:
      - routes
    verbs:
      - get
      - list
      - watch

  # Kong Ingress
  - apiGroups:
      - configuration.konghq.com
    resources:
      - tcpingresses
    verbs:
      - get
      - list
      - watch

  # Gloo Edge
  - apiGroups:
      - gloo.solo.io
      - gateway.solo.io
    resources:
      - proxies
      - virtualservices
    verbs:
      - get
      - list
      - watch

  # Skipper RouteGroup
  - apiGroups:
      - zalando.org
    resources:
      - routegroups
    verbs:
      - get
      - list
      - watch

  # CRD resources (for custom integrations)
  - apiGroups:
      - externaldns.k8s.io
    resources:
      - dnsendpoints
    verbs:
      - get
      - list
      - watch
      - update
      - patch

  # Events (for debugging and monitoring)
  - apiGroups: [""]
    resources:
      - events
    verbs:
      - create
      - patch

---
# ClusterRoleBinding for the extended permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-dns-extended
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: manual
  annotations:
    description: "Binds extended permissions to External DNS service account"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-dns-extended
subjects:
  - kind: ServiceAccount
    name: external-dns  # Must match serviceAccount.name in values file
    namespace: external-dns  # Must match the namespace where External DNS is deployed

---
# Additional ClusterRole for reading CRDs (optional)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-dns-crd-reader
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: manual
  annotations:
    description: "Allows External DNS to read CRD definitions"
rules:
  - apiGroups:
      - apiextensions.k8s.io
    resources:
      - customresourcedefinitions
    verbs:
      - get
      - list
      - watch

---
# ClusterRoleBinding for CRD reader
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-dns-crd-reader
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: manual
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-dns-crd-reader
subjects:
  - kind: ServiceAccount
    name: external-dns
    namespace: external-dns

---
# Role for namespace-specific resources (optional)
# Deploy this if you want External DNS to manage ConfigMaps or Secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: external-dns-namespace
  namespace: external-dns
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: manual
rules:
  # ConfigMaps (for configuration)
  - apiGroups: [""]
    resources:
      - configmaps
    verbs:
      - get
      - list
      - watch

  # Secrets (for credentials if not using IRSA/Pod Identity)
  - apiGroups: [""]
    resources:
      - secrets
    verbs:
      - get
      - list
      - watch

  # Leases (for leader election in multi-replica setup)
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch

---
# RoleBinding for namespace-specific permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: external-dns-namespace
  namespace: external-dns
  labels:
    app.kubernetes.io/name: external-dns
    app.kubernetes.io/component: rbac
    app.kubernetes.io/managed-by: manual
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: external-dns-namespace
subjects:
  - kind: ServiceAccount
    name: external-dns
    namespace: external-dns

---
# Usage Instructions:
#
# 1. Deploy External DNS with Helm:
#    helm install external-dns ./charts/external-dns-1.19.0.tgz \
#      -f values-dev-direct.yaml \
#      -n external-dns \
#      --create-namespace
#
# 2. Apply custom ClusterRole:
#    kubectl apply -f custom-clusterrole.yaml
#
# 3. Verify permissions:
#    kubectl auth can-i list ingresses --as=system:serviceaccount:external-dns:external-dns
#    kubectl auth can-i list gateways.gateway.networking.k8s.io --as=system:serviceaccount:external-dns:external-dns
#    kubectl auth can-i list virtualservices.networking.istio.io --as=system:serviceaccount:external-dns:external-dns
#
# 4. Check External DNS logs:
#    kubectl logs -n external-dns -l app.kubernetes.io/name=external-dns
#
# Note: Update the namespace and service account name if different from defaults

---
# Customization:
#
# If you deploy External DNS in a different namespace:
# 1. Update all "namespace: external-dns" references
# 2. Update ClusterRoleBinding subjects namespace
#
# If you use a different service account name:
# 1. Update all "name: external-dns" in subjects
# 2. Ensure it matches serviceAccount.name in values file
#
# To add more resources:
# 1. Add new apiGroups and resources to the ClusterRole
# 2. Ensure External DNS supports the resource type
# 3. Test with kubectl auth can-i

---
# Security Considerations:
#
# 1. Least Privilege:
#    - Only includes read permissions (get, list, watch)
#    - No write permissions to cluster resources
#    - Only External DNS can modify Route53 (via IAM)
#
# 2. Namespace Isolation:
#    - ClusterRole for cluster-wide resources
#    - Role for namespace-specific resources
#    - Separate bindings for each
#
# 3. Event Creation:
#    - Allows creating events for debugging
#    - Events are namespace-scoped
#    - Useful for troubleshooting
#
# 4. CRD Access:
#    - Optional CRD reader role
#    - Only needed if using DNSEndpoint CRD
#    - Can be removed if not needed

---
# Troubleshooting:
#
# If External DNS can't watch resources:
#
# 1. Check ClusterRoleBinding:
#    kubectl get clusterrolebinding external-dns-extended -o yaml
#
# 2. Verify service account:
#    kubectl get sa -n external-dns external-dns
#
# 3. Test permissions:
#    kubectl auth can-i list services --as=system:serviceaccount:external-dns:external-dns
#
# 4. Check External DNS logs for permission errors:
#    kubectl logs -n external-dns -l app.kubernetes.io/name=external-dns | grep -i "forbidden\|unauthorized"
#
# 5. Verify RBAC is enabled:
#    kubectl api-versions | grep rbac

