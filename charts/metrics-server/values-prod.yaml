# Kubernetes Metrics Server configuration for prod environment

# Authentication method: "pod-identity" or "irsa"
authMethod: "pod-identity"

# Metrics Server configuration
metrics-server:
  # Image configuration
  image:
    repository: registry.k8s.io/metrics-server/metrics-server
    tag: v0.7.1
    pullPolicy: IfNotPresent

  # Service account configuration
  serviceAccount:
    create: true
    name: metrics-server
    annotations:
      # IRSA annotation (used when authMethod is "irsa")
      eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/EKS-MetricsServer-Role-irsa-prod"
      # Pod Identity annotation (used when authMethod is "pod-identity")
      eks.amazonaws.com/pod-identity-association-role-arn: "arn:aws:iam::ACCOUNT_ID:role/EKS-MetricsServer-Role-prod"

  # Pod Identity specific configuration
  podIdentity:
    enabled: true
    roleArn: "arn:aws:iam::ACCOUNT_ID:role/EKS-MetricsServer-Role-prod"

  # Metrics server arguments
  args:
    - --cert-dir=/tmp
    - --secure-port=10250
    - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
    - --kubelet-use-node-status-port
    - --metric-resolution=15s
    # Removed kubelet-insecure-tls for production security

  # Resources - higher for production
  resources:
    requests:
      cpu: 100m
      memory: 200Mi
    limits:
      cpu: 200m
      memory: 400Mi

  # Security context
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 1000
    seccompProfile:
      type: RuntimeDefault

  # Container security context
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 1000

  # Node selector
  nodeSelector:
    kubernetes.io/os: linux

  # Tolerations
  tolerations:
    - key: node-role.kubernetes.io/master
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
    - key: CriticalAddonsOnly
      operator: Exists

  # Affinity - prefer system nodes with anti-affinity for HA
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
              - key: eks.amazonaws.com/nodegroup
                operator: In
                values: ["system"]
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: metrics-server
            topologyKey: kubernetes.io/hostname

  # Priority class
  priorityClassName: system-cluster-critical

  # API service configuration
  apiService:
    create: true
    insecureSkipTLSVerify: false  # Secure for production

  # Deployment strategy
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1

  # Pod disruption budget
  podDisruptionBudget:
    enabled: true
    minAvailable: 1

  # Monitoring - enabled for production
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
    labels:
      app: metrics-server

  # Replica count - HA for production
  replicas: 2

  # Host network (recommended for metrics server in production)
  hostNetwork:
    enabled: true

  # Additional production settings
  livenessProbe:
    httpGet:
      path: /livez
      port: https
      scheme: HTTPS
    initialDelaySeconds: 0
    periodSeconds: 10
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /readyz
      port: https
      scheme: HTTPS
    initialDelaySeconds: 20
    periodSeconds: 10
    failureThreshold: 3

  # Production-specific monitoring and logging
  monitoring:
    enabled: true
    
  logging:
    level: 2  # Less verbose for production