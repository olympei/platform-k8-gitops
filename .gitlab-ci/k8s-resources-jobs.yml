# K8s-Resources Deployment and Uninstallation Jobs
# Included in main .gitlab-ci.yml


.deploy_kustomize:
  stage: deploy
  script:
    - echo "ğŸ“¦ Applying native Kustomize resources for $ENVIRONMENT..."
    - kubectl apply -k k8s-resources/environments/$ENVIRONMENT
  only: [main]
  when: manual

deploy:kustomize:dev:
  extends: .deploy_kustomize
  variables:
    ENVIRONMENT: dev
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64
  needs: ["deploy:helm:dev"]

deploy:kustomize:prod:
  extends: .deploy_kustomize
  variables:
    ENVIRONMENT: prod
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64
  needs: ["deploy:helm:prod"]

# Deploy multiple k8s apps dynamically
deploy:k8s:apps:dev:
  extends: .deploy_k8s_apps
  variables:
    ENVIRONMENT: dev
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64
    # K8S_APPS: "ingress,storage,secrets-store-provider-aws"  # Set in CI/CD variables or leave empty for all

deploy:k8s:apps:prod:
  extends: .deploy_k8s_apps
  variables:
    ENVIRONMENT: prod
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64
    # K8S_APPS: "ingress,storage,secrets-store-provider-aws"  # Set in CI/CD variables or leave empty for all

# Template for deploying k8s-resources apps dynamically
# Supports deploying single app or multiple apps via K8S_APPS variable
.deploy_k8s_apps:
  stage: deploy
  script:
    - |
      set -e
      
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸš€ K8s Apps Deployment for $ENVIRONMENT"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      
      # Determine which apps to deploy
      if [ -n "$K8S_APPS" ]; then
        echo "ğŸ“‹ Apps to deploy (from K8S_APPS): $K8S_APPS"
        IFS=',' read -ra APPS <<< "$K8S_APPS"
      elif [ -n "$APP_NAME" ]; then
        echo "ğŸ“‹ Single app to deploy: $APP_NAME"
        APPS=("$APP_NAME")
      else
        echo "ğŸ“‹ Auto-detecting available apps..."
        mapfile -t APPS < <(find k8s-resources -mindepth 1 -maxdepth 1 -type d ! -name "environments" -exec basename {} \;)
        echo "Found apps: ${APPS[*]}"
      fi
      
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # Track deployment status
      DEPLOYED_COUNT=0
      SKIPPED_COUNT=0
      FAILED_COUNT=0
      FAILED_APPS=()
      
      # Deploy each app
      for app in "${APPS[@]}"; do
        # Trim whitespace
        app=$(echo "$app" | xargs)
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ Processing: $app"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        APP_PATH="k8s-resources/${app}/overlays/${ENVIRONMENT}"
        
        if [ ! -d "$APP_PATH" ]; then
          echo "âš ï¸  WARNING: App path not found: $APP_PATH"
          echo "Skipping $app"
          SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
          continue
        fi
        
        echo "ğŸ“‚ Path: $APP_PATH"
        echo ""
        
        echo "ğŸ” Previewing resources..."
        if ! kubectl kustomize "$APP_PATH" > /dev/null 2>&1; then
          echo "âŒ ERROR: Failed to build kustomize for $app"
          FAILED_COUNT=$((FAILED_COUNT + 1))
          FAILED_APPS+=("$app")
          continue
        fi
        
        echo "âœ… Kustomize build successful"
        echo ""
        
        echo "ğŸš€ Applying resources..."
        if kubectl apply -k "$APP_PATH"; then
          echo "âœ… Successfully deployed $app"
          DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
          
          # Show resource status
          NAMESPACE=$(kubectl kustomize "$APP_PATH" | grep "namespace:" | head -1 | awk '{print $2}' || echo "")
          if [ -n "$NAMESPACE" ]; then
            echo ""
            echo "ğŸ“Š Resources in namespace: $NAMESPACE"
            kubectl get all -n "$NAMESPACE" 2>/dev/null | head -20 || echo "No resources found"
          fi
        else
          echo "âŒ Failed to deploy $app"
          FAILED_COUNT=$((FAILED_COUNT + 1))
          FAILED_APPS+=("$app")
        fi
      done
      
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ“Š Deployment Summary"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "âœ… Successfully deployed: $DEPLOYED_COUNT apps"
      echo "â­ï¸  Skipped: $SKIPPED_COUNT apps"
      echo "âŒ Failed: $FAILED_COUNT apps"
      
      if [ $FAILED_COUNT -gt 0 ]; then
        echo ""
        echo "Failed apps:"
        for app in "${FAILED_APPS[@]}"; do
          echo "  - $app"
        done
        echo ""
        echo "âŒ Deployment completed with errors"
        exit 1
      fi
      
      echo ""
      echo "âœ… All apps deployed successfully!"
  only: [main]
  when: manual

# Backward compatible template for single app
.deploy_k8s_app:
  extends: .deploy_k8s_apps

# Individual app deployment jobs - Dev
deploy:k8s:external-dns:dev:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: external-dns
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

deploy:k8s:ingress:dev:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: ingress
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

deploy:k8s:external-secrets:dev:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: external-secrets
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

deploy:k8s:storage:dev:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: storage
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

deploy:k8s:secrets-store-provider-aws:dev:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: secrets-store-provider-aws
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

# Individual app deployment jobs - Prod
deploy:k8s:external-dns:prod:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: external-dns
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

deploy:k8s:ingress:prod:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: ingress
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

deploy:k8s:external-secrets:prod:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: external-secrets
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

deploy:k8s:storage:prod:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: storage
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

deploy:k8s:secrets-store-provider-aws:prod:
  extends: .deploy_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: secrets-store-provider-aws
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64


.uninstall_k8s_apps:
  stage: uninstall
  script:
    - |
      set -e
      
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ—‘ï¸  K8s Apps Uninstall for $ENVIRONMENT"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      
      # Determine which apps to uninstall
      if [ -n "$K8S_APPS" ]; then
        echo "ğŸ“‹ Apps to uninstall (from K8S_APPS): $K8S_APPS"
        IFS=',' read -ra APPS <<< "$K8S_APPS"
      elif [ -n "$APP_NAME" ]; then
        echo "ğŸ“‹ Single app to uninstall: $APP_NAME"
        APPS=("$APP_NAME")
      else
        echo "ğŸ“‹ Auto-detecting available apps..."
        mapfile -t APPS < <(find k8s-resources -mindepth 1 -maxdepth 1 -type d ! -name "environments" -exec basename {} \;)
        echo "Found apps: ${APPS[*]}"
      fi
      
      echo ""
      echo "âš ï¸  WARNING: This will delete resources from the cluster!"
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # Track uninstall status
      UNINSTALLED_COUNT=0
      SKIPPED_COUNT=0
      FAILED_COUNT=0
      FAILED_APPS=()
      
      # Uninstall each app (in reverse order for dependencies)
      for ((i=${#APPS[@]}-1; i>=0; i--)); do
        app="${APPS[i]}"
        # Trim whitespace
        app=$(echo "$app" | xargs)
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ—‘ï¸  Processing: $app"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        APP_PATH="k8s-resources/${app}/overlays/${ENVIRONMENT}"
        
        if [ ! -d "$APP_PATH" ]; then
          echo "âš ï¸  WARNING: App path not found: $APP_PATH"
          echo "Skipping $app"
          SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
          continue
        fi
        
        echo "ğŸ“‚ Path: $APP_PATH"
        echo ""
        
        # Check if resources exist
        echo "ğŸ” Checking for existing resources..."
        if ! kubectl kustomize "$APP_PATH" > /dev/null 2>&1; then
          echo "âš ï¸  WARNING: Failed to build kustomize for $app"
          echo "Skipping $app"
          SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
          continue
        fi
        
        # Show resources that will be deleted
        echo "ğŸ“‹ Resources to be deleted:"
        kubectl kustomize "$APP_PATH" | grep "kind:" | sort | uniq -c || echo "No resources found"
        echo ""
        
        echo "ğŸ—‘ï¸  Deleting resources..."
        if kubectl delete -k "$APP_PATH" --ignore-not-found=true --timeout=5m; then
          echo "âœ… Successfully uninstalled $app"
          UNINSTALLED_COUNT=$((UNINSTALLED_COUNT + 1))
        else
          echo "âŒ Failed to uninstall $app"
          FAILED_COUNT=$((FAILED_COUNT + 1))
          FAILED_APPS+=("$app")
        fi
      done
      
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ“Š Uninstall Summary"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "âœ… Successfully uninstalled: $UNINSTALLED_COUNT apps"
      echo "â­ï¸  Skipped: $SKIPPED_COUNT apps"
      echo "âŒ Failed: $FAILED_COUNT apps"
      
      if [ $FAILED_COUNT -gt 0 ]; then
        echo ""
        echo "Failed apps:"
        for app in "${FAILED_APPS[@]}"; do
          echo "  - $app"
        done
        echo ""
        echo "âŒ Uninstall completed with errors"
        exit 1
      fi
      
      echo ""
      echo "âœ… All apps uninstalled successfully!"
  only: [main]
  when: manual

# Uninstall all k8s-resources apps
uninstall:k8s:apps:dev:
  extends: .uninstall_k8s_apps
  variables:
    ENVIRONMENT: dev
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64
    # K8S_APPS: "ingress,storage,secrets-store-provider-aws"  # Set in CI/CD variables or leave empty for all

uninstall:k8s:apps:prod:
  extends: .uninstall_k8s_apps
  variables:
    ENVIRONMENT: prod
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64
    # K8S_APPS: "ingress,storage,secrets-store-provider-aws"  # Set in CI/CD variables or leave empty for all

# Backward compatible template for single app uninstall
.uninstall_k8s_app:
  extends: .uninstall_k8s_apps

# Individual k8s-resources app uninstall jobs - Dev
uninstall:k8s:external-dns:dev:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: external-dns
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

uninstall:k8s:ingress:dev:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: ingress
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

uninstall:k8s:external-secrets:dev:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: external-secrets
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

uninstall:k8s:storage:dev:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: storage
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

uninstall:k8s:secrets-store-provider-aws:dev:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: dev
    APP_NAME: secrets-store-provider-aws
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

# Individual k8s-resources app uninstall jobs - Prod
uninstall:k8s:external-dns:prod:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: external-dns
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

uninstall:k8s:ingress:prod:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: ingress
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

uninstall:k8s:external-secrets:prod:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: external-secrets
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

uninstall:k8s:storage:prod:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: storage
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

uninstall:k8s:secrets-store-provider-aws:prod:
  extends: .uninstall_k8s_app
  variables:
    ENVIRONMENT: prod
    APP_NAME: secrets-store-provider-aws
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

# Template for uninstalling all kustomize resources (environment-level)
.uninstall_kustomize:
  stage: uninstall
  script:
    - |
      echo "ğŸ—‘ï¸  Uninstalling all Kustomize resources for $ENVIRONMENT..."
      echo ""
      echo "âš ï¸  WARNING: This will delete ALL resources managed by k8s-resources/environments/$ENVIRONMENT"
      echo ""
      
      KUSTOMIZE_PATH="k8s-resources/environments/$ENVIRONMENT"
      
      if [ ! -d "$KUSTOMIZE_PATH" ]; then
        echo "âŒ ERROR: Kustomize path not found: $KUSTOMIZE_PATH"
        exit 1
      fi
      
      echo "ğŸ“‚ Path: $KUSTOMIZE_PATH"
      echo ""
      
      # Show resources that will be deleted
      echo "ğŸ“‹ Resources to be deleted:"
      kubectl kustomize "$KUSTOMIZE_PATH" | grep "kind:" | sort | uniq -c || echo "No resources found"
      echo ""
      
      echo "ğŸ—‘ï¸  Deleting all resources..."
      if kubectl delete -k "$KUSTOMIZE_PATH" --ignore-not-found=true --timeout=10m; then
        echo "âœ… Successfully uninstalled all kustomize resources"
      else
        echo "âŒ Failed to uninstall kustomize resources"
        exit 1
      fi
  only: [main]
  when: manual

uninstall:kustomize:dev:
  extends: .uninstall_kustomize
  variables:
    ENVIRONMENT: dev
    KUBECONFIG_DATA: $DEV_KUBECONFIG_B64

uninstall:kustomize:prod:
  extends: .uninstall_kustomize
  variables:
    ENVIRONMENT: prod
    KUBECONFIG_DATA: $PROD_KUBECONFIG_B64

